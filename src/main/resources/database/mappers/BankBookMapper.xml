<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.iu.s1.bankBook.BankBookDAO">
  	<sql id="searchCondition">
	  	<if test="kind == 'contents'">
	  			WHERE BOOKDETAIL LIKE '%' || #{search} || '%'
	  		</if>
	  		<if test="kind == 'title'">
	  			WHERE BOOKNAME LIKE '%' || #{search} || '%'
	  		</if>
  	</sql>
  	<sql id="searchCondition2">
  		 WHERE 
			<choose>	
				<when test="kind == 'contents'">
					BOOKDETAIL
				</when>
				<otherwise>
					BOOKNAME
				</otherwise>
			</choose> 
					
					LIKE '%' || #{search} || '%'
   
  	</sql>
  
  	<select id="getBookNumber" resultType="long">
  		SELECT BANKNUM_SEQ.NEXTVAL FROM DUAL
  	</select>
  	<select id="getBankBookList" parameterType="Pager" resultType="BankbookDTO">
  		SELECT * FROM (
  			SELECT ROWNUM R, B.* FROM (
				SELECT * FROM BANKBOOK
				<include refid="searchCondition2"></include>
				
				
				ORDER BY BOOKNUMBER DESC
			) B
		)
		WHERE R BETWEEN #{startRow} AND #{lastRow}
  	</select>
  	<select id="getBankBookDetail" parameterType="BankBookDTO" resultMap="bankBookDetailResult">
  		SELECT * 
		FROM BANKBOOK B 
			LEFT OUTER JOIN 
			BANKBOOKIMG BI 
			USING(BOOKNUMBER) 
		WHERE BOOKNUMBER = #{bookNumber}
  	</select>
  	
  	<resultMap type="bankBookDTO" id="bankBookDetailResult">
  		<!-- Primary key -->
  		
  		<id column="BOOKNUMBER" property="bookNumber"/>
  		<result column="BOOKNAME" property="bookName"/>
  		<result column="BOOKDETAIL" property="bookDetail"/>
  		<result column="BOOKRATE" property="bookRate"/>
  		<result column="BOOKSALE" property="bookSale"/>
  		<!-- 1:1 -->
  		<association property="bankBookImgDTO" javaType="bankBookImgDTO">
  			<id column="FILENUM" property="fileNum"/>
  			<result column="FILENAME" property="fileName"/>
  			<result column="ORINAME" property="oriName"/>
  		</association>
  		<!-- 1:N -->
  		<!-- <collection property=""></collection> -->
  	</resultMap>
  	<select id="getBankbookCount" resultType="long" parameterType="pager">
  		SELECT COUNT(BOOKNUMBER) FROM BANKBOOK
  			<include refid="searchCondition"></include>
  		
  	</select>
  	
 	<insert id="setBankBookAdd" parameterType="BankBookDTO">
 		<selectKey keyProperty="bookNumber" resultType="Long" order="BEFORE">
 			SELECT BANKNUM_SEQ.NEXTVAL FROM DUAL
 		</selectKey>
 		INSERT INTO BANKBOOK 
 		VALUES (#{bookNumber}, #{bookName}, #{bookRate}, #{bookSale}, #{bookDetail})
 	</insert>
 	<delete id="setBankBookDelete" parameterType="BankBookDTO">
 		DELETE BANKBOOK 
 		WHERE BOOKNUMBER = #{bookNumber}
 	</delete>
 	<update id="setBankBookUpdate" parameterType="BankBookDTO">
 		UPDATE BANKBOOK SET BOOKNAME = #{bookName}, BOOKDETAIL = #{bookDetail}, BOOKRATE = #{bookRate}, BOOKSALE = #{bookSale} 
 		WHERE BOOKNUMBER = #{bookNumber}
 	</update>
 	
 	<insert id="setBankBookImgAdd" parameterType="BankBookImgDTO">
 		INSERT INTO BANKBOOKIMG
 		VALUES (BANKNUM_SEQ.NEXTVAL, #{fileName}, #{oriName}, #{bookNumber})
 	
 	</insert>
 	
 	
 	
  </mapper>